<!-- CptS 489, Spring 2019
     Project: Task Tracker
     File: schedule.html
     This file is responsible allowing the user to plan out time blocks to work on different tasks.
     These time blocks are separate from the due date, and encourage the user to work on their tasks in a timely mannner.
     This page displays a day view, where all the hours are mapped out and the user is able to select a time to schedule a task.
-->

<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Import External stylesheets and libraries using 'CDN' (content delivery network) links: -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
        integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css"
        integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <script src="../js/model.js"></script>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT" crossorigin="anonymous">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
        integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous">
    </script>

    <link rel="stylesheet" href="../css/app.css">
</head>

<body>
    <nav class="nav" id="navbar"></nav>

    <div id="tasks" class="container page-container">

        <h1 id="selectedDate"></h1>
        <div class='d-flex justify-content-between flex-row' id="scheduleHeader">

            <button type="button" class="btn btn-secondary" id="prevDayBtn"
                style='margin-top:auto; margin-bottom: auto;'>
                <i class="fas fa-chevron-left"></i>&nbsp;
                Prev Day
            </button>
            <button type="button" class="btn btn-secondary" id="nextDayBtn"
                style='margin-top:auto; margin-bottom: auto;'>
                Next Day&nbsp;
                <i class="fas fa-chevron-right"></i>
            </button>

        </div>

        <!-- Modal -->
        <div class="modal fade" id="timeblockEditModal" tabindex="-1" role="dialog"
            aria-labelledby="timeblockModalLabel" aria-hidden="true" style="margin: auto">
            <div class="vertical-alignment-helper">
                <div class="modal-dialog vertical-align-center" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <center style="width:100%;">
                                <h3 class="modal-title" id="exampleModalLabel">Add/Edit Timeblock BLAH-DITTY-BLAH</h3>
                            </center>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form class="d-flex flex-column">
                                <span class="dropdown" style="float: right; width: 100%;">
                                    <button class="btn btn-outline-secondary dropdown-toggle task-dropdown"
                                        type="button" id="taskDropdown" data-toggle="dropdown" aria-haspopup="true"
                                        aria-expanded="false" style="width: 100%; margin-bottom: 8px;">
                                        Select a task...
                                    </button>
                                    <div class="dropdown-menu" id="taskDropdownMenu"
                                        aria-labelledby="dropdownMenuButton"></div>
                                </span>

                                <span class="d-flex flex-row">

                                    <div class="p-2 flex-grow-1">Start:</div>

                                    <span class="input-group" style="flex-grow: 0; flex-shrink: 0; flex-basis: 8em;">
                                        <div class="input-group-prepend">
                                            <button class="btn btn-outline-secondary input-minus" type="button">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                        <input type="number" min="1" max="12" size="2" value="06"
                                            class="form-control input-hour input-no-spinner" placeholder="12"
                                            aria-label="Hour" aria-describedby="basic-addon2" id="inputStartHour">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary input-plus" type="button">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </span>

                                    <center class="p-2">:</center>

                                    <span class="input-group" style="flex-grow: 0; flex-shrink: 0; flex-basis: 8em;">
                                        <div class="input-group-prepend">
                                            <button class="btn btn-outline-secondary input-minus" type="button">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                        <input type="number" min="0" max="45" step="15" size="2"
                                            class="form-control input-no-spinner" placeholder="Minute"
                                            aria-label="Minute" aria-describedby="basic-addon2" value="00"
                                            id="inputStartMinute">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary input-plus" type="button">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </span>

                                    <div class="p-2"></div>

                                    <div class="btn-group btn-group-toggle" data-toggle="buttons"
                                        style="flex-grow: 0; flex-shrink: 0; flex-basis: 6em;">
                                        <label class="btn btn-outline-secondary active">
                                            <input type="radio" name="options" id="optionStartAM" autocomplete="off"
                                                checked>
                                            AM
                                        </label>
                                        <label class="btn btn-outline-secondary">
                                            <input type="radio" name="options" id="optionStartPM" autocomplete="off">PM
                                        </label>
                                    </div>
                                </span>

                                <span class="d-flex flex-row">
                                    <div class="p-2 flex-grow-1">End:</div>

                                    <span class="input-group" style="flex-grow: 0; flex-shrink: 0; flex-basis: 8em;">
                                        <div class="input-group-prepend">
                                            <button class="btn btn-outline-secondary input-minus" type="button">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                        <input type="number" min="1" max="12" size="2" value="06"
                                            class="form-control input-hour input-no-spinner" placeholder="12"
                                            aria-label="Hour" aria-describedby="basic-addon2" id="inputEndHour">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary input-plus" type="button">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </span>

                                    <center class="p-2">:</center>

                                    <span class="input-group" style="flex-grow: 0; flex-shrink: 0; flex-basis: 8em;">
                                        <div class="input-group-prepend">
                                            <button class="btn btn-outline-secondary input-minus" type="button">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                        </div>
                                        <input type="number" min="0" max="45" step="15" size="2"
                                            class="form-control input-no-spinner" placeholder="Minute"
                                            aria-label="Minute" aria-describedby="basic-addon2" value="00"
                                            id="inputEndMinute">
                                        <div class="input-group-append">
                                            <button class="btn btn-outline-secondary input-plus" type="button">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </span>

                                    <div class="p-2"></div>

                                    <div class="btn-group btn-group-toggle" data-toggle="buttons"
                                        style="flex-grow: 0; flex-shrink: 0; flex-basis: 6em;">
                                        <label class="btn btn-outline-secondary active">
                                            <input type="radio" name="options" id="optionEndAM" autocomplete="off"
                                                checked>
                                            AM
                                        </label>
                                        <label class="btn btn-outline-secondary">
                                            <input type="radio" name="options" id="optionEndPM" autocomplete="off">PM
                                        </label>
                                    </div>
                                </span>
                            </form>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal"
                                id="btnDiscard">Discard</button>
                            <button type="button" input="submit" class="btn btn-primary" id="btnSave"
                                data-dismiss="modal">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table style="width: 100%; margin-bottom: 64px;" cellpadding="2" class="table-sm">
                <colgroup width="15%" valign="middle" span="1" align="center"></colgroup>
                <colgroup width="" valign="middle" span="1" align="center"></colgroup>
                <colgroup width="85%" valign="middle" span="1" align="center"></colgroup>
                <tbody>
                    <tr bgcolor="#007bff">
                        <th>
                            <h4>Hour</h4>
                        </th>
                        <th>
                            <h4>Min</h4>
                        </th>
                        <th>
                            <h4>Tasks</h4>
                        </th>
                    </tr>
                </tbody>
            </table>
        </div>

        <button type="button" class="btn btn-primary floating-action-btn" data-toggle="modal"
            data-target="#timeblockEditModal">
            Schedule Timeblock
        </button>
    </div>
</body>

<script>
    //load the navbar when the page loads
    $(document).ready(function () {
        $("#navbar").load("navbar.html", function () {
            $("#nav-schedule").addClass("nav-active");
            resizeNav();
        });
        generateTableRows(5, 24); //generates tables for the whole 24 hour day
        loadModalDropdown();

        var today = new Date();
        $("#selectedDate").html(today.toDateString() + ":");

        console.log(String(5).padStart(2, 0));
    });


    // Function to generate rows for a table to make it look like a calendar.
    // The table will have 24 hours (12AM-11PM) and be broken down into sections of 15 minutes.
    function generateTableRows(startHour, endHour) {
        var rowHTML = "";
        var time;
        var meridian = "AM";
        for (var i = startHour; i < endHour; i++) {
            time = (i % 12);
            if (time == 0)
                time = 12;
            if (i >= 12)
                meridian = "PM"

            rowHTML +=
                "<tr style='line-height:10px'>" +
                "    <td rowspan='4' scope='row'><span>" + time + ":00 " + meridian + "</span></td>" +
                "    <td class='td-minute'>00</td>" +
                "    <td class='empty-task-time' id='time-" + i + "-0" + "' ></td>" +
                "</tr>" +
                "<tr style='line-height:10px'>" +
                "    <td class='td-minute'>15</td>" +
                "    <td class='empty-task-time' id='time-" + i + "-15" + "' ></td>" +
                "</tr>" +
                "<tr style='line-height:10px'>" +
                "    <td class='td-minute'>30</td>" +
                "    <td class='empty-task-time' id='time-" + i + "-30" + "' ></td>" +
                "</tr>" +
                "<tr style='line-height:10px'>" +
                "    <td class='td-minute'>45</td>" +
                "    <td class='empty-task-time' id='time-" + i + "-45" + "' ></td>" +
                "</tr>";
        }
        $("tbody").append(rowHTML);
    }

    //event handler for when the user clicks on an empty time slot to add a task to.
    //It will show them the schedule time block modal and populate it with an hour
    //time block from where they clicked.
    $(document.body).on("click", ".empty-task-time", function (e) {
        var temp = e.target.id.split('-'); // empty time block's ids are displayed as times in 24hr format
        var hour24 = parseInt(temp[1]);
        var hour = hour24 % 12;
        var endHour = hour +
        1; //by default we would schedule a time block as 1 hour long for simplicity for the user.
        var quarter = parseInt(temp[2]);

        // Showing whether the time selected is AM or PM
        if (hour24 >= 12) {
            $("#optionStartAM").parent().removeClass("active");
            $("#optionStartPM").parent().addClass("active");
        } else {
            $("#optionStartAM").parent().addClass("active");
            $("#optionStartPM").parent().removeClass("active");
        }

        // Showing whether the default 1 hour later end time is AM or PM
        if (hour24 + 1 >= 12 && hour24 + 1 < 24) {
            $("#optionEndAM").parent().removeClass("active");
            $("#optionEndPM").parent().addClass("active");
        } else {
            $("#optionEndAM").parent().addClass("active");
            $("#optionEndPM").parent().removeClass("active");
        }

        // Padding times that are less than 10 with a 0 to make them uniform
        if (quarter < 10) {
            quarter = "0" + quarter.toString();
        }
        if (hour < 10) {
            hour = "0" + hour.toString();
        }
        if (endHour < 10) {
            endHour = "0" + endHour.toString();
        }

        // setting the actual start and end times in the modal.
        $("#inputStartHour").val(hour % 12 == 0 ? '12' : hour % 12);
        $("#inputEndHour").val(endHour % 12 == 0 ? '12' : endHour % 12);
        $("#inputEndMinute").val(quarter);
        $("#inputStartMinute").val(quarter);

        $("#timeblockEditModal").modal("show"); //open the modal
    });

    // Event handler for when the time block editor is opened.
    // Will query the model for a list of tasks and populate the dropdown with what it recieves.
    function loadModalDropdown() {
        var tasks = getTaskList();
        var taskSelectHTML = "";

        //First build html elements for each item in the drop
        tasks.forEach(task => {
            taskSelectHTML += "<a class='dropdown-item task-dropdown-item' id='task:" + task.id + "'>" + task
                .title + "</a>";
        });
        $("#taskDropdownMenu").html(taskSelectHTML);
    };

    // Event handler for when a task from the dropdown is clicked.
    // Updates the text of the dropdown to be the contents of the item that was clicked.
    $(document.body).on("click", ".task-dropdown-item", function (e) {
        $("#taskDropdown").html(e.target.innerHTML);
        taskId = (e.target.id).split(':')[1];
        $("#taskDropdown").data("taskId", taskId);
    });

    // Event handler for .input-minus button click event
    // when the button is clicked, decrement the corresponding input value
    $(document.body).on("click", ".input-minus", function (e) {
        var inputGroup = $(this).closest(".input-group")[0];
        var input = $(inputGroup).find("input")[0];
        var min = Number($(input).prop("min"))
        var step = Number($(input).prop("step"))
        var currentVal = Number($(input).val());
        var newVal = currentVal;
        if (currentVal > min || null == min) {
            if (step) {
                newVal -= step;
            } else {
                newVal--;
            }
        }
        if (newVal < 10) {
            newVal = "0" + newVal;
        }
        $(input).val(newVal);
    });

    // Event handler for .input-plus button click event
    // when the button is clicked, increment the corresponding input value
    $(document.body).on("click", ".input-plus", function (e) {
        var inputGroup = $(this).closest(".input-group")[0];
        var input = $(inputGroup).find("input")[0];
        var currentVal = Number($(input).val());
        var newVal = currentVal;
        var max = Number($(input).prop("max"))
        var step = Number($(input).prop("step"))

        if (currentVal < max || null == max) {
            if (step) {
                newVal += step;
            } else {
                newVal++;
            }
        }

        if (newVal < 10) {
            newVal = "0" + newVal;
        }
        $(input).val(newVal);
    });



    $("#btnSave").click(function () {
        var startHour = Number($("#inputStartHour").val()),
            startMinute = Number($("#inputStartMinute").val()),
            startIsPM = $("#optionStartPM").closest("label").hasClass('active'),
            endHour = Number($("#inputEndHour").val()),
            endMinute = Number($("#inputEndMinute").val()),
            endIsPM = $("#optionEndPM").closest("label").hasClass('active');

        startHour %= 12;
        endHour %= 12;
        startHour += (startIsPM ? 12 : 0);
        endHour += (endIsPM ? 12 : 0);
        var nRows = ((endHour - startHour) * 4) - (startMinute / 15) + (endMinute / 15);
        if ($(getRowId(startHour, startMinute, nRows)).hasClass("task-time-block")) {
            return;
        }
        taskId = Number($("#taskDropdown").data("taskId"));
        addTask(startHour, startMinute, nRows, taskId);
    });

    function addTask(startHour, startMinute, nRows, taskId) {
        var tdId = "#time-" + startHour + "-" + startMinute;
        var task = getTask(taskId);
        $(tdId).prop("rowspan", nRows);
        $(tdId).removeClass("emty-task-time");
        $(tdId).addClass("task-time-block");
        $(tdId).html(task.title);
        setPriorityColor(tdId, task.priority);

        currentHour = startHour;
        currentMinute = (startMinute + 15) % 60;
        if (45 == startMinute) {
            currentHour++;
        }

        for (var i = 0; i < nRows - 1; i++) {
            console.log(tdId)
            tdId = "#time-" + currentHour + "-" + currentMinute;
            $(tdId).remove();
            if (currentMinute == 45) {
                currentMinute = 0;
                currentHour++;
            } else {
                currentMinute += 15;
            }
        }
    }

    function setPriorityColor(elementId, priority) {
        switch (priority) {
            case 0:
                $(elementId).addClass("priority-low");
                break;
            case 1:
                $(elementId).addClass("priority-med");
                break;
            case 2:
                $(elementId).addClass("priority-high");
                break;
        }
    }

    function getRowId(hour24, minute, rowOffset) {
        var currentHour = hour24,
            currentMinute = minute,
            tdId;
        for (var i = 0; i < rowOffset - 1; i++) {
            if (currentMinute == 45) {
                currentMinute = 0;
                currentHour++;
            } else {
                currentMinute += 15;
            }
        }
        return "#time-" + currentHour + "-" + currentMinute;
    }
</script>